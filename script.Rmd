---
title: "Untitled"
output: html_document
date: "2023-01-08"
---


```{r lib, message=FALSE, warning=FALSE, paged.print=FALSE}
library(ggpmisc)
library(DescTools)
library(ggfortify) # diagnostics plot
library(cowplot)
library(patchwork)
library(glue)
library(latex2exp)
library(biscale)
library(sp)
library(pROC)
library(scales)
library(janitor)
library(tidyverse)
library(sf)      # for spTransform() & project()
library(data.table)
library(raster)
library(broom)
library(flextable)
library(patchwork)
# diagnostics models:
library(performance)
library(ggResidpanel)
library(report)
library(broom)

# custom functions
`%notin%` <- Negate(`%in%`)
select=dplyr::select
rename=dplyr::rename
filter=dplyr::filter
summarize=dplyr::summarize
count=dplyr::count
drop_na=tidyr::drop_na
group_by=dplyr::group_by
mutate=dplyr::mutate
```
```{r include=FALSE}
extrafont::loadfonts(device = "win")
```
# load functions

```{r plt-map-fun}
my.colors=c("#313695","#4575b4","#74add1","#abd9e9","#e0f3f8","#ffffbf","#fee090","#fdae61","#f46d43","#d73027","#a50026")
#my.colors = colorRampPalette(c("#2c7bb6","#ffffbf","#d7191c"))(11)
plot.map<- function(NE_places.df, continious=TRUE,alpha = 0.5, size = 1){
  names(NE_places.df) <- c("lon", "lat","PROB")
# Create an sf object from the data frame
sf_object <- st_as_sf(NE_places.df, coords = c("lon", "lat"), crs = 4326)

# Transform the coordinates to the desired CRS
transformed_sf <- st_transform(sf_object, crs = PROJ)

# Extract the transformed coordinates and convert them to a data frame
NE_places.df.prj <- as.data.frame(st_coordinates(transformed_sf))

# Rename the columns
names(NE_places.df.prj)[1:2] <- c("X.prj", "Y.prj")
# transform to data.table (easier to work with)
NE_places.dt.prj <- data.table(NE_places.df.prj,NE_places.df)

plt<- ggplot() +
  # add locations (points); add opacity with "alpha" argument
  geom_point(data = NE_places.dt.prj, 
             aes(x = X.prj, y = Y.prj, colour = PROB),size = size, 
             alpha = alpha) +
  geom_polygon(data = NE_countries.prj, 
               aes(long,lat, group = group), 
               colour = "gray70", fill = "gray90", size = .25) +
  # add projected bounding box
  geom_polygon(data = NE_box.prj, 
               aes(x = long, y = lat), 
               colour = "black", fill = "transparent", size = .25) +
  # add graticules
  geom_path(data = NE_graticules.prj, 
            aes(long, lat, group = group), 
            linetype = "dotted", colour = "grey50", linewidth = .25) +
  # add graticule labels - latitude and longitude
  geom_text(data = lbl.Y.prj, # latitude
            aes(x = X.prj, y = Y.prj, label = lbl), 
            colour = "grey50", size = 2) +
  geom_text(data = lbl.X.prj, # latitude
            aes(x = X.prj, y = Y.prj*1.04, label = lbl), 
            colour = "grey50", size = 2) +
  # __ Set aspect ratio
  coord_fixed(ratio = 1) +
  # __ Set empty theme
  theme_void(base_size=12, base_family="Times New Roman") + # remove the default background, gridlines & default gray color around legend's symbols
  # final theme tweaks
  theme(legend.title = element_text(colour="black", size=10, face="bold",angle = 90), # adjust legend title
        legend.title.align = 0.5,
        legend.direction = "vertical",
        legend.margin=margin(0,0,0,0),
        legend.box.margin=margin(0,0,0,0),
        #legend.position = c(1.01, 0.25), # relative position of legend
        plot.margin = unit(c(t=0, r=1, b=0, l=0), unit="cm")
        ) 
if (continious==FALSE) {
  plt
}else{
  plt+scale_color_gradientn(colours = my.colors,#RColorBrewer::brewer.pal(11, 'Spectral')[11:1],
                                                   guide = guide_colourbar(
                          title.position = "left",  barwidth=0.5,barheight=10,ticks=TRUE,
                          nbin = 10))
}
  
}

scale_fill_Publication <- function(...){
  library(scales)
  discrete_scale("fill","Publication",manual_pal(values = c("#386cb0","#fdb462","#7fc97f","#ef3b2c","#662506","#a6cee3","#fb9a99","#984ea3","#ffff33","darkgreen")), ...)
  
}

scale_colour_Publication <- function(...){
  library(scales)
  discrete_scale("colour","Publication",manual_pal(values = c("#386cb0","#fdb462","#7fc97f","#ef3b2c","#662506","#a6cee3","#fb9a99","#984ea3","#ffff33","darkgreen")), ...)
  
}

```
```{r ltg-plot-fun}
ltg<- function(df){
  df |> 
  ggplot()+
  geom_point(aes(latitude, total, color=total))+
    
 scale_y_continuous(breaks = scales::pretty_breaks(n = 5))+
  stat_summary(aes(latitude, total, color=total), fun.y=mean, geom="line", colour="black")+
  
    
  #theme(legend.position = "none")+
  theme(legend.title = element_text(colour="black", size=10, face="bold",angle = 90),
        legend.title.align = 0.5)+
  scale_x_continuous(breaks= c(-60,-30,0,30,60),
                              labels=c("60°S","30°S","0","30°N","60°N"),
                              limits=c(-80,90) )+
  coord_flip()+
  theme_Publication()+

    scale_color_gradientn(colours = my.colors,#RColorBrewer::brewer.pal(11, 'Spectral')[11:1],
                        guide = guide_colourbar(
                          title.position = "left",  barwidth=0.5,barheight=10,ticks=TRUE,
                          nbin = 10))+
  theme(legend.position = "right",
            legend.key.size= unit(0.2, "cm"),
            legend.spacing = unit(0, "cm"),
            legend.title = element_text(face="bold",angle = 90),
        legend.title.align = 0.5)
}
```


```{r plot.map2D}
plot.map2D<- function(dt2D, dim=4,  xlab = "species richness",ylab = "total rarity", pal= "BlueYl"){
  dim=dim
# before projecting, transform NE_places to data frame to use it inside ggplot()
NE_places.df <- bi_class(dt2D, x = total, y = sum, style = "quantile", dim = dim)
names(NE_places.df) <- c("lon", "lat","PROB","PROB1","bi_class")
# NE_places.df.prj  <- project(cbind(NE_places.df$lon, NE_places.df$lat), proj = PROJ) |> data.frame()
# names(NE_places.df.prj)[1:2] <- c("X.prj","Y.prj")
# transform to data.table (easier to work with)
NE_places.dt.prj <- data.table(NE_places.df,NE_places.df)

# Create an sf object from the data frame
sf_object <- st_as_sf(NE_places.df, coords = c("lon", "lat"), crs = 4326)

# Transform the coordinates to the desired CRS
transformed_sf <- st_transform(sf_object, crs = PROJ)

# Extract the transformed coordinates and convert them to a data frame
NE_places.df.prj <- as.data.frame(st_coordinates(transformed_sf))

# Rename the columns
names(NE_places.df.prj)[1:2] <- c("X.prj", "Y.prj")
# transform to data.table (easier to work with)
NE_places.dt.prj <- data.table(NE_places.df.prj,NE_places.df)

map<- ggplot() +
  geom_point(data = NE_places.dt.prj, 
             aes(x = X.prj, y = Y.prj, color=bi_class),size = 1, 
              show.legend = FALSE) +
  bi_scale_color(pal = pal, dim = dim) +
  geom_polygon(data = NE_countries.prj, 
               aes(long,lat, group = group), 
               colour = "gray70", fill = "gray90", size = .25) +
  geom_polygon(data = NE_box.prj, 
               aes(x = long, y = lat), 
               colour = "black", fill = "transparent", size = .25) +
  geom_path(data = NE_graticules.prj, 
            aes(long, lat, group = group), 
            linetype = "dotted", colour = "grey50", size = .25) +
  geom_text(data = lbl.Y.prj, # latitude
            aes(x = X.prj, y = Y.prj, label = lbl), 
            colour = "grey50", size = 2) +
  geom_text(data = lbl.X.prj, # latitude
            aes(x = X.prj, y = Y.prj*1.04, label = lbl), 
            colour = "grey50", size = 2) +
  coord_fixed(ratio = 1) +
  theme_void() + # remove the default background, gridlines & default gray color around legend's symbols
  # final theme tweaks
  theme(legend.title = element_text(colour="black", size=10, face="bold",angle = 90), # adjust legend title
        legend.title.align = 0.5,
        legend.direction = "vertical",
        legend.margin=margin(0,0,0,0),
        legend.box.margin=margin(-10,-10,-10,-10),
        #legend.position = c(1.01, 0.25), # relative position of legend
        plot.margin = unit(c(t=0, r=1, b=0, l=0), unit="cm")
        ) 

legend <- bi_legend(pal = pal,
                    dim = dim,
                    xlab = xlab,
                    ylab = ylab,
                    size = 8)+
  theme(
    plot.background = element_blank(),
    panel.grid.major = element_blank(),
    panel.grid.minor = element_blank(),
    panel.border = element_blank()
  )

# combine map with legend
ggdraw() +
  draw_plot(map, 0, 0, 1, 1) +
  draw_plot(legend, 0.76, .74, 0.3, 0.3)

}
```
```{r theme_Publication}
# theme for plotting
source(here::here("fun/theme_Publication.R"))
```

# 1. Load Data

```{r}
# load maps 
load("rds/map.RData")
load("rds/NPPdata.rda")
load("rds/POCdata.rda")

grid <- read_csv("data/GEO.csv",show_col_types=FALSE) |> select(longitude,latitude,ProvId,EPI_MESO_BOUNDARY_M,MESO_BATHY_BOUNDARY_M)
PROJ <- "+proj=eck4 +lon_0=0 +x_0=0 +y_0=0 +ellps=WGS84 +datum=WGS84 +units=m +no_defs" 

# species richness data
#max.sp_lat<- read_csv("data/species_richness.csv") 
tot_rar<- read_csv("data/total-range-size-rarity-FILTERED.csv") |>  rename(tot_rar=sum)
avr_rar<- read_csv( "data/avrg-size-rarity-FILTERED.csv") |>  rename(avrg_rar=sum)
# number of species per lat/lon
sp<-read_csv("data/ENSEMBLE_occ.wmean.tot.csv")
# biomass data
malaspina.dt <- read_delim("data/Malaspina_zoopl_biom.tab", 
    delim = "\t", escape_double = FALSE, 
    trim_ws = TRUE, skip = 80)
```


```{r}
diver_biom<- sp |> rename(SR =total) |> 
#  right_join(max.sp_lat) |>   rename(SRmax =count) |> 
  right_join(poc.clim) |> rename( m2_poc=m2,m3_poc=m3) |> 
  right_join(npp.clim) |> rename( m2_npp=m2,m3_npp=m3) |> 
  left_join(grid) |>
  left_join(tot_rar)|>
  left_join(avr_rar)|> 
  mutate(
    basin = case_when(
      ProvId %in% c(1) ~ "Arctic",
      ProvId %in% c(2, 3, 4, 5, 6, 11, 12) ~ "North Pacific",
      ProvId %in% c(7, 8, 9 , 10, 13) ~ "South Pacific",
      ProvId %in% c(14, 15, 16, 17, 18, 19, 20) ~ "Indian Ocean",
      ProvId %in% c(21, 22, 23, 24, 25, 26) ~ "North Atlantic",
      ProvId %in% c(27, 28, 29, 30) ~ "South Atlantic",
      ProvId %in% c(31, 32, 33) ~ "Southern Ocean",
    )) 

diver_biom

```

Biomass and rarity graphs
```{r}
SR_Biom <- diver_biom %>%
  select(avrg_rar, tot_rar, m2_poc, SR, basin) |> arrange(avrg_rar)

#Global average rarity
SR_Biom_avrg <- SR_Biom |> select(avrg_rar, m2_poc, SR) |>
  mutate(basin = "Global")  |> arrange(avrg_rar)

#Global total rarity + Per Ocean basins
SR_Biom_tot <- SR_Biom |> select(tot_rar, m2_poc, SR) |>
  mutate(basin = "Total range-size rarity (Global)",
         avrg_rar = tot_rar) |> select(-tot_rar) |>
  arrange(avrg_rar)
```


# 2. Models


```{r Fig1,fig.height=8, fig.width=12, warning=FALSE}
## 2.1 SLR plots"#4575b4","#74add1","#abd9e9",
m2_npp.plt<- m2_npp |> ggplot(aes(y=bio,x=npp/10^3))+
  geom_point() +
  stat_poly_line(color='#313695',fill='#4575b4')+
  stat_poly_eq(aes(label = paste(after_stat(eq.label),
                                 after_stat(rr.label), sep = "*\", \"*")))+
  scale_x_log10()+
  scale_y_log10()+
  labs(x=TeX(r'(\textbf{NPP $(g C \cdot m^{-2} \cdot day^{-1})$})'),
       y=TeX(r'(\textbf{Mesopelagic Zoop C $(g \cdot m^{-2})$})'),
       title="NPP Estimates")+
  theme_Publication()

m3_npp.plt<-m3_npp |> 
  ggplot(aes(y = bio, x = npp / 10 ^ 3)) +
  geom_point() +
   stat_poly_line(color='#313695',fill='#4575b4')+
  stat_poly_eq(aes(label = paste(after_stat(eq.label),
  after_stat(rr.label), sep = "*\", \"*")))+
  scale_x_log10() +
  scale_y_log10()+
  labs(x=TeX(r'(\textbf{NPP $(g C \cdot m^{-2} \cdot day^{-1})$})'),
      y=TeX(r'(\textbf{Mesopelagic Zoop C $(g \cdot m^{-2})$})'))+
  theme_Publication()

m2_poc.plt<- m2_poc |> ggplot(aes(y=bio,x=POC))+
  geom_point() +
   stat_poly_line(color='#313695',fill='#4575b4')+
  stat_poly_eq(aes(label = paste(after_stat(eq.label),
                                 after_stat(rr.label), sep = "*\", \"*")))+
  scale_x_log10()+
  scale_y_log10()+
  labs(x=TeX(r'(\textbf{POC $(mg C \cdot m^{-3})$})'),
      y=TeX(r'(\textbf{Mesopelagic Zoop C $(g \cdot m^{-2})$})'),
       title="POC Estimates")+
  theme_Publication()

m3_poc.plt<-m3_poc |> 
  ggplot(aes(y=bio,x=POC))+
  geom_point() +
   stat_poly_line(color='#313695',fill='#4575b4')+
  stat_poly_eq(aes(label = paste(after_stat(eq.label),
  after_stat(rr.label), sep = "*\", \"*")))+
  scale_x_log10()+
  scale_y_log10()+
  labs(x=TeX(r'(\textbf{POC $(mg C \cdot m^{-3})$})'),
    y=TeX(r'(\textbf{Mesopelagic Zoop C $(g \cdot m^{-2})$})'))+
  theme_Publication()

plot_grid(m2_npp.plt,m2_poc.plt,
          m3_npp.plt,m3_poc.plt,
          labels = "AUTO", label_size = 12, align = "h",hjust = -5, ncol= 2)
ggsave("img/Fig.1_biomas-plots-SLR.png", width=25, height=20, units="cm", dpi=300)
```

```{r FigS6,fig.height=8, fig.width=9}
### 2.2 Model Diagnostics
# Combine the top and bottom rows with a spacer in between
plot_grid(resid_panel(model2_npp), NULL, resid_panel(model2_poc),
          NULL,NULL,NULL,
          resid_panel(model3_npp), NULL, resid_panel(model3_poc),
                        ncol = 3,   labels = c("A","","B","","","","C","","E"), 
          label_size = 12, rel_widths = c(1, 0.15, 1),rel_heights = c(1, 0.15, 1))

ggsave("img/Fig.S6_biomas-plots-ModelDiag.png", width=9, height=9, units="in", dpi=300)
```

```{r}
sjPlot::tab_model(model2_npp,model3_npp,
                  model2_poc,model3_poc,show.intercept = T,p.style =  "numeric_stars",show.stat=T,dv.labels = c("NPP Variable Depth", "NPP Classical Depth","POC Variable Depth", "POC Classical Depth"))

```

```{r TableS1 }
## Tables
eval_npp.tbl<- rbind(
      glance(model2_npp) |>  mutate(model="Variable Depth"),
      glance(model3_npp) |>  mutate(model="Classical Depth")
) |> mutate_if(is.numeric,round,2) |> 
  select(model, everything(), -deviance, -df.residual) |>  
  mutate(p.value= case_when(
    p.value < 0.01 ~"<0.01",
    TRUE ~ as.character(p.value)
  )) |> 
  mutate(Model="NPP") |> 
  select(Model, everything())

eval_poc.tbl<- rbind(
      glance(model2_poc) |>  mutate(model="Variable Depth"),
      glance(model3_poc) |>  mutate(model="Classical Depth")
) |> mutate_if(is.numeric,round,2) |> 
  select(model, everything(), -deviance, -df.residual) |>  
  mutate(p.value= case_when(
    p.value < 0.01 ~"<0.01",
    TRUE ~ as.character(p.value)
  )) |> 
  mutate(Model="POC") |> 
  select(Model, everything())


sum.stat<-rbind(eval_npp.tbl,eval_poc.tbl)|> 
    flextable() |>  
  theme_booktabs() |> 
   merge_v( j=1) |> 
  valign(j = 1, valign = "top", part = "body") |> 
  autofit() |> fix_border_issues()
sum.stat
rm(eval_poc.tbl, eval_npp.tbl)
#print(sum.stat , "docx")
```



```{r TableS2}
coef_npp.tbl<- rbind(
      tidy(model2_npp) |>  mutate(Model="Variable Depth"),
      tidy(model3_npp) |>  mutate(Model="Classical Depth")
) |> mutate_if(is.numeric,round,3) |> 
  mutate(term = case_when(
    term=="(Intercept)"~"Intercept",
    term=="log_npp"~"ln(NPP)"
  )) |>  
  mutate(p.value= case_when(
    p.value < 0.01 ~"<0.01",
    TRUE ~ as.character(p.value)
  )) |> 
  select(Model, everything()) 
  
coef_poc.tbl<- rbind(
      tidy(model2_npp) |>  mutate(Model="Variable Depth"),
      tidy(model3_npp) |>  mutate(Model="Classical Depth")
) |> mutate_if(is.numeric,round,3) |> 
  mutate(term = case_when(
    term=="(Intercept)"~"Intercept",
    term=="log_poc"~"ln(POC)"
  )) |>  
  mutate(p.value= case_when(
    p.value < 0.01 ~"<0.01",
    TRUE ~ as.character(p.value)
  )) |> 
  select(Model, everything())   

coef.stat<-rbind(coef_npp.tbl,coef_poc.tbl)|> 
    flextable() |>  
  theme_booktabs() |> 
   merge_v( j=1) |> 
  valign(j = 1, valign = "top", part = "body") |> 
  autofit()|> fix_border_issues()
coef.stat
#print(coef.stat , "docx")
```

```{r}
rm(model2_npp, model2_poc,model3_npp,model3_poc)
```


## 3. ENV variable coverage


```{r FigS4, fig.height=8, fig.width=8, warning=FALSE}
### ENV Maps
npp_map<-plot.map(npp.clim[,c("longitude","latitude","npp")] |> mutate(npp=npp/1000))+
  labs(color=TeX(r'(\textbf{NPP $(mg C \cdot m^{-2} \cdot day^{-1})$})'),)+
  scale_color_gradientn(colours = my.colors,
                        trans="sqrt",
                       breaks=trans_breaks('sqrt', function(x) x^2),
                       labels=trans_format('sqrt', function(x) round(x^2,1)),
                        guide = guide_colourbar(title.position = "left",
                      barwidth=0.5,barheight=10,ticks=TRUE,
                          nbin = 10))
poc_map<-plot.map(poc.clim[,c("longitude","latitude","POC")])+
  labs(color=TeX(r'(\textbf{POC $(mg C \cdot m^{-3})$})'))+
  scale_color_gradientn(colours = my.colors,
                        trans="log10",
                        breaks=trans_breaks('log10', function(x) 10^x),
                        labels=trans_format('log10', function(x) round(10^x,1)),
                        guide = guide_colourbar(title.position = "left",
                      barwidth=0.5,barheight=10,ticks=TRUE,
                          nbin = 10))

plot_grid(npp_map,poc_map,labels = "AUTO", label_size = 12, align = "h",hjust = -5, ncol= 1)
ggsave("img/Fig.S4_biomas-plots-POC-NPP.png", width=8, height=8, units="in", dpi=300)
```

```{r FigS5,fig.height=4, fig.width=10, message=FALSE, warning=FALSE}
### Density Polts
## DENSITY NPP AND POC---------------------------------------------------
den.npp<- ggplot(npp.clim) +
  geom_density(aes(x = log(npp), colour = "Global"))+
  geom_density(data=data_npp, aes(x = log(npp), colour = "Data"))+
  geom_density(data=npp.clim|>  filter(latitude>=-40, latitude<=40), 
               aes(x = log(npp), colour = "40S-40N"))+
  theme_Publication()+
  scale_colour_Publication()+
  labs(x="ln(NPP)",  color="Source")

den.poc <-ggplot(poc.clim) +
  geom_density(aes(x = log(POC), colour = "Global"))+
  geom_density(data=data_poc, aes(x = log(POC), colour = "Data"))+
  geom_density(data=poc.clim|>  filter(latitude>=-40, latitude<=40), 
               aes(x = log(POC), colour = "40S-40N"))+
  theme_Publication()+
  scale_colour_Publication()+
  labs(x="ln(POC)", color="Source")

den.npp + theme(legend.position="none")+
  den.poc+ 
  plot_layout(widths = 1) +  plot_annotation(tag_levels = 'A') & 
  theme(plot.tag = element_text("Times New Roman",face = "bold", size = 12,hjust = -3, vjust = 0))
ggsave("img/Fig.S5_biomas-plots-ENV-DensityPlots.png", width=25, height=20, units="cm", dpi=300)
```

```{r}
# summary stats
## POC
psych::describe(data_poc$POC)
psych::describe(poc.clim$POC)
## NPP
psych::describe(data_npp$npp)
psych::describe(npp.clim$npp)
```

# 4. Biomass Estimates

```{r Table2}
biom.estimates <-rbind(biom.estimates_npp,biom.estimates_poc) |> filter(Model!="m1") |> 
  mutate(Model=ifelse(Model=="m2","Variable Depth","Classical Depth")) |> 
  pivot_wider(names_from = Extent, values_from = Estimate)

biom.estimates.tbl<- biom.estimates|>
  flextable() |> autofit() |>
  merge_v(j=2) |> 
  valign(j = 2, valign = "top", part = "body") |> 
  fix_border_issues()
biom.estimates.tbl
rm(biom.estimates,biom.estimates_npp,biom.estimates_poc)
#print(biom.estimates.tbl , "docx") 
```

## 5. Global Maps


```{r fig.height=5, fig.width=12}
npp.clim1<- npp.clim |> mutate(log_m2=log(m2),log_m3=log(m3)) |> filter(log_m2> -10)

map2_npp<- plot.map(npp.clim1[,c("longitude","latitude","m2")])+
  labs(color=TeX(r'(\textbf{Zoop C $(g \cdot m^{-2})$})'))+
  scale_color_gradientn(colours = my.colors,
                        trans="log10",
                        breaks=trans_breaks('log10', function(x) 10^x),
                        labels=trans_format('log10', function(x) round(10^x,1)),
                        guide = guide_colourbar(title.position = "left",
                      barwidth=0.5,barheight=10,ticks=TRUE,
                          nbin = 10))+
  labs(subtitle="NPP-based Variable Depth Model")
map3_npp<- plot.map(npp.clim1[,c("longitude","latitude","m3")])+
  labs(color=TeX(r'(\textbf{Zoop C $(g \cdot m^{-2})$})'))+
  scale_color_gradientn(colours = my.colors,
                        trans="log10",
                        breaks=trans_breaks('log10', function(x) 10^x),
                        labels=trans_format('log10', function(x) round(10^x,1)),
                        guide = guide_colourbar(title.position = "left",
                      barwidth=0.5,barheight=10,ticks=TRUE,
                          nbin = 10))+
  labs(subtitle="NPP-based Classical Depth Model")

ldg2_npp<- npp.clim1[, c("longitude","latitude","m2")] |> 
  mutate(total=m2) |>
  select(-m2) |> 
  ltg()+
  labs(x="Latitude (cell midpoint)",color=TeX(r'(\textbf{Zoop C $(g \cdot m^{-2})$})'),y="")+
  scale_y_log10(labels=trans_format('log10', function(x) round(10^x,1)))+
  scale_color_gradientn(colours = my.colors,
                        trans="log10",
                        breaks=trans_breaks('log10', function(x) 10^x),
                        labels=trans_format('log10', function(x) round(10^x,4)),
                        guide = guide_colourbar(title.position = "left",
                      barwidth=0.5,barheight=10,ticks=TRUE,
                          nbin = 10))
ldg3_npp<- npp.clim1[, c("longitude","latitude","m3")] |> 
  mutate(total=m3) |>
  select(-m3) |> 
  ltg()+
  scale_y_log10(labels=trans_format('log10', function(x) round(10^x,1)))+
  labs(x="Latitude (cell midpoint)",color=TeX(r'(\textbf{Zoop C $(g \cdot m^{-2})$})'),y="")+
  scale_color_gradientn(colours = my.colors,
                        trans="log10",
                        breaks=trans_breaks('log10', function(x) 10^x),
                        labels=trans_format('log10', function(x) round(10^x,4)),
                        guide = guide_colourbar(title.position = "left",
                      barwidth=0.5,barheight=10,ticks=TRUE,
                          nbin = 10))

patch2_npp= map2_npp+theme(legend.position="none")+ldg2_npp+plot_layout(widths=c(3,1.))
patch3_npp= map3_npp+theme(legend.position="none")+ldg3_npp+plot_layout(widths=c(3,1.))

rm(map2_npp,map3_npp, ldg2_npp,ldg3_npp)
```
```{r fig.height=5, fig.width=12}
# before projecting, transform NE_places to data frame to use it inside ggplot()
map2_poc<- plot.map(poc.clim[,c("longitude","latitude","m2")])+
  labs(color=TeX(r'(\textbf{Zoop C $(g \cdot m^{-2})$})'))+
  scale_color_gradientn(colours = my.colors,
                        trans="log10",
                        breaks=trans_breaks('log10', function(x) 10^x),
                        labels=trans_format('log10', function(x) round(10^x,1)),
                        guide = guide_colourbar(title.position = "left",
                      barwidth=0.5,barheight=10,ticks=TRUE,
                          nbin = 10))+
  labs(title="POC-based Variable Depth Model")
map3_poc<- plot.map(poc.clim[,c("longitude","latitude","m3")])+
  labs(color=TeX(r'(\textbf{Zoop C $(g \cdot m^{-2})$})'))+
  scale_color_gradientn(colours = my.colors,
                        trans="log10",
                        breaks=trans_breaks('log10', function(x) 10^x),
                        labels=trans_format('log10', function(x) round(10^x,1)),
                        guide = guide_colourbar(title.position = "left",
                      barwidth=0.5,barheight=10,ticks=TRUE,
                          nbin = 10))+
  labs(title="POC-based Classical Depth Model")

# latitudinal gradient
ldg2_poc<- poc.clim[, c("longitude","latitude","m2")] |> mutate(total=m2) |>
  select(-m2) |> 
  ltg()+
  scale_y_log10(labels=trans_format('log10', function(x) round(10^x,1)))+
  labs(x="Latitude (cell midpoint)",color=TeX(r'(\textbf{Zoop C $(g \cdot m^{-2})$})'),y="")+
  scale_color_gradientn(colours = my.colors,
                        trans="log10",
                        breaks=trans_breaks('log10', function(x) 10^x),
                        labels=trans_format('log10', function(x) round(10^x,1)),
                        guide = guide_colourbar(title.position = "left",
                      barwidth=0.5,barheight=10,ticks=TRUE,
                          nbin = 10))

ldg3_poc<- poc.clim[, c("longitude","latitude","m3")] |> mutate(total=m3) |>
  select(-m3) |> 
  ltg()+
  scale_y_log10(labels=trans_format('log10', function(x) round(10^x,1)))+
  labs(x="Latitude (cell midpoint)",color=TeX(r'(\textbf{Zoop C $(g \cdot m^{-2})$})'),y="")+
  scale_color_gradientn(colours = my.colors,
                        trans="log10",
                        breaks=trans_breaks('log10', function(x) 10^x),
                        labels=trans_format('log10', function(x) round(10^x,1)),
                        guide = guide_colourbar(title.position = "left",
                      barwidth=0.5,barheight=10,ticks=TRUE,
                          nbin = 10))

patch2_poc= map2_poc+theme(legend.position="none")+ldg2_poc+plot_layout(widths=c(3,1))
patch3_poc= map3_poc+theme(legend.position="none")+ldg3_poc+plot_layout(widths=c(3,1))

#remove not needed parts
rm(map2_poc,map3_poc, ldg2_poc,ldg3_poc)
```

```{r Fig2,fig.height=8, fig.width=17, message=FALSE, warning=FALSE}
patch1<- patch2_npp / patch3_npp  
patch2<- patch2_poc / patch3_poc

(patch1 | patch2) + 
  plot_layout(heights = 1) +  
  plot_annotation(tag_levels = c('A',"","B","","C","","D")) & 
  theme(plot.tag = element_text("Times New Roman",face = "bold", size = 12,hjust = -3, vjust = 0))

ggsave("img/Fig.2_biomas-plots-climatology.png", width=22, height=10, units="in", dpi=300)
```




# 6. Diversity vs Biomass Based on POC m2


```{r message=FALSE, warning=FALSE}
#saveRDS(diver_biom, file="diver_biom.rds")
rm(max.sp_lat,tot_rar,avr_rar,sp)
```

```{r FigS1,fig.height=8, fig.width=10, warning=FALSE}
library(ggnewscale)
mesopel_labels_prov <- read_csv("data/mesopel_labels_prov.csv")
# Create an sf object from the data frame
sf_object <- st_as_sf(mesopel_labels_prov, coords = c("longitude", "latitude"), crs = 4326)
# Transform the coordinates to the desired CRS
transformed_sf <- st_transform(sf_object, crs = PROJ)
# Extract the transformed coordinates and convert them to a data frame
mesopel_labels.prj <- as.data.frame(st_coordinates(transformed_sf))
# Rename the columns
names(mesopel_labels.prj )[1:2] <- c("X.prj", "Y.prj")
# transform to data.table (easier to work with)
mesopel_labels_prov <- data.table(mesopel_labels.prj,mesopel_labels_prov) |> select(-longitude, -latitude)


mes.prov_plt<-plot.map(grid |> drop_na(ProvId)|> mutate(ProvId=factor(ProvId)) |> select(longitude,latitude,ProvId), continious=FALSE, alpha=0.6)+
  scale_color_manual(values=c("#211674","#6e4e07","#d2c59c","#857346","#a2863f","#c0985e","#520077","#9e4b68","#fdbbe9","#e100ac","#a10013","#f58083","#d30b28","#e2e1e1","#b2b2b1","#828282","#4f4f4f","#85f8c6","#4c8d6e","#a1dabf","#3341a8","#4947e6","#52c2fb","#8cd3ff","#3681ab","#c3d0fe","#a5ff00","#a5ff00","#a5d365","#6f8c43","#eabafe","#ca90ff","#ca00ff"))+ 
  new_scale_color() +
  geom_text(data = mesopel_labels_prov,
            aes(X.prj, Y.prj, label = ProvId, color = color),
            size = 2.5) + theme(legend.position = "none") +
  scale_color_manual(values = c("black", "white"))

## Biomass per Province
biom_prov<- diver_biom|> 
 select(ProvId, m2_poc, basin) |>
  drop_na() |>
  group_by(ProvId, basin) %>%
  mutate(ProvId=as.character(ProvId),
         ProvId=factor(ProvId, levels=as.character(c(1:33)))) |> 
  ggplot( aes(x=ProvId, y=m2_poc, color=basin)) +
  stat_summary(fun.data= "mean_se")+
  #scale_y_log10(labels=trans_format('log10', function(x) round(10^x,1)))+
  theme_Publication()+
  labs(y=TeX(r'(\textbf{Zoop C $(g \cdot m^{-2})$})'), x="Mesopelagic province ID")+
  scale_y_log10(#breaks=pretty_breaks(n=6), 
                     #labels= math_format(10^.x),
                     labels=trans_format('log10', function(x) round(10^x,1)))+
  scale_colour_Publication()+
  geom_hline(yintercept = mean(diver_biom$m2_poc, na.rm=TRUE),
             linetype="dashed")

(mes.prov_plt / biom_prov) + 
  plot_layout(heights = c(1.5,1)) +  
  plot_annotation(tag_levels = c('A',"B")) & 
  theme(plot.tag = element_text("Times New Roman",face = "bold", size = 12))

ggsave("img/Fig.S1_biomas-plots-ProvId_Biomass.png", width=10, height=8, units="in", dpi=300)

```




```{r}
## 2D Biom vs SR + LDG
dt2D <- diver_biom[,c("longitude","latitude","m2_poc","SR")] |> drop_na()

SRBio_2D<- plot.map2D(dt2D |> select(longitude,latitude, total=SR, sum=m2_poc), dim=4,  xlab = "Biomass",ylab = "potential SR")
```

```{r Fig4,fig.height=5, fig.width=12, warning=FALSE}

# ===> means show teh same pattern
ldg<- diver_biom[,c("longitude","latitude","m2_poc","SR")] |> 
  group_by(latitude) |> 
  summarize(m2_mean=mean(log10(m2_poc), na.rm=TRUE),
            m2_median=median(log10(m2_poc), na.rm=TRUE),
            m2_sd=sd(m2_poc, na.rm=TRUE),
            SR_mean=mean(log10(SR), na.rm=TRUE),
            SR_median=median(log10(SR), na.rm=TRUE),
            SR_sd=sd(SR, na.rm=TRUE)) 
  
scaleFactor <- 1. #max(ldg$m2_mean) / max(ldg$SR_mean)

ldg.plt<-ldg |> ggplot(aes(x=latitude))+
  geom_line( aes(y=m2_median), color="blue",linetype = 2,linewidth = 0.5) + 
  # geom_line( aes(y=m2_mean), color="blue",linetype = 1,linewidth = 0.5) + 
 # geom_ribbon(aes(y = m2_mean, ymin = m2_mean - m2_sd, ymax = m2_mean + m2_sd), fill = "blue", alpha=0.5)+
  geom_line( aes(y=SR_median* scaleFactor),color="black",linetype = 1,linewidth = 0.5) + #* scaleFactor
 # geom_line( aes(y=SR_mean* scaleFactor),color="black",linetype = 2,linewidth = 0.5) + #* scaleFactor
  #geom_ribbon(aes(y = SR_mean, ymin = SR_mean - SR_sd, ymax = SR_mean + m2_sd), fill = "black", alpha=0.5)+
  scale_y_continuous(name =TeX(r'(\textbf{Zoop C $(g \cdot m^{-2})$})'),labels=function(x) round(10^x,1),
    sec.axis = sec_axis(~ . /scaleFactor , name="Species Richness",labels=function(x) round(10^x,1))  )+#/scaleFactor
  theme_Publication()+
  labs(x="Latitude (cell midpoint)")+
  theme(
    axis.title.x = element_text(color = "blue", size=13),
    axis.text.x = element_text(color = "blue"),
    axis.title.x.top = element_text(color = "black", size=13),
    axis.text.x.top = element_text(color = "black")
  ) +
  scale_x_continuous(breaks= c(-66.5,-23.5, 0, 23.5, 66.5),
                              labels=c("66.5°S","23.5°S","0","23.5°N","66.5°N"),
                              limits=c(-80,90) )+
  
  coord_flip()

SRBio_2D + ldg.plt+  
  plot_layout(widths =  c(3.5, 1))+ 
  plot_annotation(tag_levels = 'A') & 
  theme(plot.tag = element_text("Times New Roman",face = "bold", size = 12))

ggsave("img/Fig.4_biomas-plots-Bio-SR-LDG.png", width=12, height=5, units="in", dpi=300)
```




```{r Fig3, fig.height=5, fig.width=10, warning=FALSE}
## Bio vs SR by POC
diver_biom |> 
  arrange(POC) |> 
  ggplot(aes(m2_poc, SR, color=POC)) +
   geom_point(alpha=0.7)+
  
  scale_x_log10(breaks = trans_breaks("log10", function(x) 10^x),
              labels = trans_format("log10", math_format(10^.x))) +
     scale_y_log10(breaks = trans_breaks("log10", function(x) 10^x),
              labels = trans_format("log10", math_format(10^.x))
              )+
  annotation_logticks() +
  theme_Publication()+
  scale_color_gradientn(colours = my.colors,
                        trans="log10",
                        guide = guide_colourbar(angle=90,
                        title.position = "left",  barwidth=0.5,barheight=10,ticks=TRUE,
                        nbin = 10))+
  geom_smooth(color="black",method = "gam", se=FALSE)+
  labs(x=TeX(r'(\textbf{Zoop C $(g \cdot m^{-2})$})'), 
       color=TeX(r'(\textbf{POC $(mg C \cdot m^{-3})$})'),
       y="Potential Species Richness")+
   theme(legend.position = "right",
            legend.key.size= unit(0.2, "cm"),
            legend.spacing = unit(0, "cm"),
            legend.title = element_text(face="bold",angle = 90),
        legend.title.align = 0.5)

ggsave("img/Fig.3_biomas-plots-SR_Biomass_colorPOC.png", width=10, height=5, units="in", dpi=300)
```





```{r Fig5, fig.height=12, fig.width=10, message=FALSE, warning=FALSE}
# Biom vs Rarity
p1<-rbind(SR_Biom_avrg ,SR_Biom|> select(-tot_rar)) |> mutate(
  basin=factor(basin, levels=c("Global",
                               unique(SR_Biom$basin)))) |>
   arrange(avrg_rar)|> 
 ggplot(aes(x=avrg_rar, y=m2_poc, color=SR))+
 geom_point(alpha=0.5)+
 scale_x_log10(breaks = trans_breaks("log10", function(x) 10^x),
              labels = trans_format("log10", math_format(10^.x))) +
 scale_y_log10(breaks = trans_breaks("log10", function(x) 10^x),
              labels = trans_format("log10", math_format(10^.x))) +
 annotation_logticks() +
 geom_point()+
 facet_wrap(~basin, scales = "free_y",ncol =2)+
 theme_Publication()+
 panel_border()+
 geom_smooth(color="black",method = "loess", se=FALSE)+
 scale_color_gradientn(colours = my.colors,
                        trans="sqrt",
                        guide = guide_colourbar(
                          title.position = "top",  barwidth=0.5,barheight=10,ticks=TRUE,
                          nbin = 10))+
  labs(y=TeX(r'(Zoop C $(g \cdot m^{-2})$)'), color="SR", x="Average range-size rarity")

p2<- SR_Biom_tot |> mutate(basin="Total range-size rarity (Global)",
  basin=as.factor(basin)) |> 
  ggplot(aes(x=avrg_rar, y=m2_poc, color=SR))+
  geom_point(alpha=0.5)+
  scale_x_log10(breaks = trans_breaks("log10", function(x) 10^x),
              labels = trans_format("log10", math_format(10^.x))) +
     scale_y_log10(breaks = trans_breaks("log10", function(x) 10^x),
              labels = trans_format("log10", math_format(10^.x))) +
   annotation_logticks() +
  geom_point()+
  facet_wrap(~basin)+
  theme_Publication()+
  panel_border()+
  geom_smooth(color="black",method = "loess", se=FALSE)+
  scale_color_gradientn(colours = my.colors,
                        trans="sqrt",
                        guide = guide_colourbar(
                          title.position = "top",  barwidth=0.5,barheight=10,ticks=TRUE,
                          nbin = 10))+
  labs(y=TeX(r'(Zoop C $(g \cdot m^{-2})$)'), color="SR", x="Total range-size rarity") 

# combine plots
p2  / p1 + 
  plot_layout(heights = c(1, 3), guides = 'collect')+ 
  plot_annotation(tag_levels = 'A')& 
  theme(plot.tag = element_text("Times New Roman",face = "bold", size = 12,hjust = -3, vjust = 0))

ggsave("img/Fig.5_biomas-plots-DiversityBiomass.png", width=10, height=15, units="in", dpi=300)
```


# 7. Cluster Bio+SR

```{r FigS7,  warning=FALSE}
library(factoextra)

# Loading dataset
df <- diver_biom |> mutate(m2_poc=log10(m2_poc)) |>  drop_na()

# Scaling dataset
df1 <- scale(df |> select(m2_poc, SR))

# Run the function to see how many clusters
km10 <- kmeans(df1, centers = 10, nstart = 25)

# Visualize the clusters
fviz_cluster(km10, data = df1,labelsize = 0)+
  scale_color_manual(values=as.vector(rcartocolor::carto_pal(12, "Safe")))+
  theme_Publication()+
  labs(x="Biomass (log10)", y="SR")

ggsave("img/Fig.7_clusters_plot.png", width=5, height=5, units="in", dpi=300)
```


```{r}
## Proud et al. Map
shp <- raster::shapefile("shp/Proud_provinces_shapefle/mesobio2/mesobio.shp")
shp <- spTransform(shp, CRS('+proj=longlat +datum=WGS84'))

## Set up a raster "template" for a 1 degree grid
ext <- extent(shp)
gridsize <- 1
r <- raster(ext, res=gridsize)
## Rasterize the shapefile
rr <- rasterize(shp, r)
#plot(rr)

df.proud<-cbind(coordinates(rr),as.data.frame(rr))
# put all the coordinates on a grid
closest_RANN <- RANN::nn2(query  = df.proud[, 1:2], 
                          data = grid[, 1:2],
                          k = 1)
proud.gridded <- cbind(df.proud, grid[closest_RANN$nn.idx,1:2 ]) |> 
  select(-x, -y) |> 
  mutate(bio_mg_m3=id) 
proud.gridded
rm(shp, df.proud,rr)
```

```{r Fig7, fig.height=3, fig.width=10}
plot_grid(
proud.gridded |> 
  select(longitude, latitude, id) |> 
  drop_na() |> 
  mutate(id=factor(id))|> 
  plot.map(continious=FALSE, alpha=1)+
  scale_color_manual(values=as.vector(rcartocolor::carto_pal(12, "Safe")))+
  labs(color="Cluster")+ 
    guides(colour = guide_legend(title.position = "left")) + 
  theme(legend.position = "none"),

df |> mutate(cluster= as.factor(km10$cluster)) |> 
  select(longitude, latitude, cluster)|> plot.map(continious=FALSE, alpha=1)+
  scale_color_manual(values=as.vector(rcartocolor::carto_pal(12, "Safe")))+
  labs(color="Cluster") + 
    guides(colour = guide_legend(title.position = "left")) + 
  theme(legend.position = "none"),

labels="AUTO", ncol = 2
)

ggsave("img/Fig.7_clusters_Proud_vs_ThisWork.png", width=10, height=3, units="in", dpi=300)

```






# 8. Surface vs Deep biomass

## Mediterenian Sea

```{r FigS3,fig.height=5, fig.width=10, warning=FALSE}
library(maps)
library(metR)
mediter<- diver_biom |>  filter(longitude <80, longitude >-5, latitude >25,latitude<44)
world_map <- map_data("world")|>  filter(long <40, long>-10, lat >28,lat<47)

medi.plt<- ggplot(world_map, aes(x = long, y = lat, group = group)) +
  geom_tile(data = mediter, aes(longitude,latitude,fill = m2_poc,group = 1)) +  
  geom_polygon(fill = "lightgray", colour = "black") +
  scale_fill_gradientn(colours = my.colors,
                        trans="log10",
                        guide = guide_colourbar(barwidth = 0.5,barheight = 10,ticks = TRUE,nbin = 10)) +
 #scale_color_continuous(trans = 'log10')+
  theme_Publication() +
  coord_equal() +
  scale_x_longitude(ticks = 10) +
  scale_y_latitude(ticks = 5)+
  labs(fill = TeX(r'($log_{10}Bio$)'),x="",y="") 
medi.plt
ggsave("img/Fig.S3_biomas-plots-mediterenian.png", width=18, height=7, units="cm", dpi=300)
```

## Stromberg et al (2009)

Strömberg, Smyth, Allen, Pitois,  O'Brien,2009,Estimation of global zooplankton biomass from satellite ocean colour,
Journal of Marine Systems,Volume 78, Issue 1,pp 18-27,ISSN 0924-7963,https://doi.org/10.1016/j.jmarsys.2009.02.004.
(https://www.sciencedirect.com/science/article/pii/S0924796309000669)

Data downloaded from : https://www.st.nmfs.noaa.gov/plankton/biomass/stromberg-biomass-qtr-degree-m00.csv.gz
```{r fig.height=10, fig.width=8, message=FALSE, warning=FALSE}
stromberg_biomass_qtr_degree_m00 <- read_csv("shp/stromberg-biomass-qtr-degree-m00.csv", 
    col_names = FALSE) |> rename(lon=1, lat=2,bio=4)

# put on eqvi-area scale
closest_RANN <- RANN::nn2(query  = stromberg_biomass_qtr_degree_m00[, 1:2], 
                          data = grid[, 1:2],
                          k = 1)
# average values per longitude/latitude
obrien.gridded <- cbind(stromberg_biomass_qtr_degree_m00, grid[closest_RANN$nn.idx,1:2 ]) |> 
  select(-lon, -lat) |> group_by(longitude, latitude) |> 
  summarize(bio_mgC_m3=mean(bio, na.rm=TRUE)) |> 
  ungroup()
obrien.gridded

p1<-obrien.gridded|> 
  select(longitude, latitude,total=bio_mgC_m3)|> 
  drop_na() |> 
  plot.map()+
  labs(title="Stromberg et al. (2009)",
       color=TeX(r'(\textbf{Epi Biomass,  $mg C \cdot m^{-3}$})'))+
  scale_color_gradientn(colours = RColorBrewer::brewer.pal(11, 'Spectral')[11:1],
                        trans="log10",
                        breaks=trans_breaks('log10', function(x) 10^x),
                        labels=trans_format('log10', function(x) round(10^x,1)),
                        guide = guide_colourbar(title.position = "left",
                      barwidth=0.5,barheight=10,ticks=TRUE,
                          nbin = 10))
###for meso 200-1000
obrien.dt<- right_join(diver_biom |> select(latitude, longitude, m3_poc),
                   obrien.gridded |> select(latitude, longitude, bio_mgC_m3),
                   by = c("longitude", "latitude"))  |> 
  mutate(obrien_gC_m2= bio_mgC_m3*200/10^3,
         ratio_epi_meso=obrien_gC_m2/m3_poc)  

p2<- obrien.dt|> 
  drop_na(m3_poc, bio_mgC_m3)|> 
  select(longitude, latitude, total=bio_mgC_m3, sum=m3_poc)|> 
  plot.map2D( dim=4,  ylab = "meso", xlab = "epi",pal= "BlueYl")

p3<-obrien.dt|> drop_na(ratio_epi_meso) |> 
  select(longitude, latitude,total=ratio_epi_meso)|> 
  drop_na() |> 
  plot.map() +
  scale_color_gradientn(colours = my.colors,
                        trans="sqrt",
                        breaks=trans_breaks('sqrt', function(x) x^2),
                        labels=trans_format('sqrt', function(x) round(x^2,1)),
                        guide = guide_colourbar(title.position = "left",
                      barwidth=0.5,barheight=10,ticks=TRUE,
                          nbin = 10))+
  theme(legend.position = "right",
            legend.key.size= unit(0.2, "cm"),
            legend.spacing = unit(0, "cm"),
            legend.title = element_text(face="bold",angle = 90),
        legend.title.align = 0.5)+
  labs(color="Epi:Meso Biomas Ratio")
  
patch_stromberg <- p1 /p3 / p2 + plot_layout(heights=c(1,1,1.1))
patch_stromberg
```
```{r}
# estimate a total epipelagic zooplankton
obrien.gridded |>  
  summarize(total_epi=sum(bio_mgC_m3, na.rm=TRUE)*200/10^3*3091.075*10^6/10^15)
psych::describe(obrien.dt$ratio_epi_meso,quant=c(.25,.75) )
```

## Bogorov et al (1968)

Bogorov, V.G., Vinogradov, M.D., Varonina, N.M., Kanaeva, I.P., and Suetova, I.A. 1968. Distribution of zooplankton biomass within the surficial layer of the world ocean. Dokl. Akad. Nauk. USSR, 182: 1205-1207
```{r FigS2,fig.height=4, fig.width=8}
# Bogorov, V.G., Vinogradov, M.D., Varonina, N.M., Kanaeva, I.P., and Suetova, I.A. 1968. Distribution of zooplankton biomass within the surficial layer of the world ocean. Dokl. Akad. Nauk. USSR, 182: 1205-1207
nc <-   st_read(here::here("shp/V3_BIOMAS_VALUE_SHAPFILE/BIOMAS_VALUE.shp")) |>
  filter(bio_mg_m3 !="boundary line") |> 
  mutate(bio_mg_m3=factor(bio_mg_m3, levels=c("<25","25-50","51-100","101-200","201-500",">500")))  |>
  st_transform(PROJ)

bogov.map <- ggplot(nc, aes(fill = bio_mg_m3)) +
  theme_minimal() +
  geom_sf() +
  scale_fill_brewer(type = "qual")
bogov.map


ggsave("img/Fig.S2_map-Bogrov.png", width=29.7, height=14, units="cm", dpi=300)
```
```{r fig.height=10, fig.width=8}
shp <- raster::shapefile("shp/V3_BIOMAS_VALUE_SHAPFILE/BIOMAS_VALUE.shp")
shp <- spTransform(shp, CRS('+proj=longlat +datum=WGS84'))

## Set up a raster "template" for a 1 degree grid
ext <- extent(shp)
gridsize <- 1
r <- raster(ext, res=gridsize)
## Rasterize the shapefile
rr <- rasterize(shp, r)
#plot(rr)

df.bogrov<-cbind(coordinates(rr),as.data.frame(rr)) |> filter(bio_mg_m3 != "boundary line")
# put all the coordinates on a grid
closest_RANN <- RANN::nn2(query  = df.bogrov[, 1:2], 
                          data = grid[, 1:2],
                          k = 1)
bogrov.gridded <- cbind(df.bogrov, grid[closest_RANN$nn.idx,1:2 ]) |> 
  select(-x, -y) |> 
  mutate(bio_original=bio_mg_m3,
         bio_mg_m3=case_when(
    bio_mg_m3=="<25" ~"0-50",
    bio_mg_m3=="25-50" ~"0-50",
    bio_mg_m3=="51-100" ~"51-200",
    bio_mg_m3=="101-200" ~"51-200",
    bio_mg_m3=="201-500" ~"201-500",
    bio_mg_m3==">500" ~">500"
  ),
 bio_mg_m3=factor(bio_mg_m3, levels=c("0-50","51-200","201-500",">500")),
 bio_original=factor(bio_original, levels=c("<25","25-50","51-100","101-200","201-500",">500"))) |> 
  mutate(bio_mg_m3_num=case_when(
    bio_original=="<25" ~12.5, #mg/m3 ww3091.075
    bio_original=="25-50" ~37.5,
    bio_original=="51-100" ~75.5,
    bio_original=="101-200" ~150.5,
    bio_original=="201-500" ~350.5,
    bio_original==">500" ~750 # max = 1000mg or 1g
  ),
  bogrov_gC_m2= bio_mg_m3_num * 100*0.12/10^3)
rm(shp, df.bogrov,rr)

#200-1000 m
 p1<- bogrov.gridded |> select(longitude, latitude,bio_original) |> 
  plot.map(continious=FALSE, alpha=1) +
  scale_color_manual(values = c("#313695","#74add1","#fee090","#fdae61","#f46d43","#a50026"))+ 
  guides(color = guide_legend(title = TeX(r'(\textbf{Biomass $(mg \cdot m^{-3})$})'), 
                              title.position = "left"))+
  theme(legend.position = "right",
            legend.key.size= unit(0.2, "cm"),
            legend.spacing = unit(0, "cm"),
            legend.title = element_text(face="bold",angle = 90),
        legend.title.align = 0)+
  labs(title="Bogorov et al (1968)")


bogrov.dt<- right_join(diver_biom |> select(latitude, longitude, m3_poc),
                   bogrov.gridded,
                   by = c("longitude", "latitude"))|> 
  mutate(ratio_epi_meso=bogrov_gC_m2/m3_poc)  

p2<-bogrov.dt|> drop_na(m3_poc, bio_mg_m3) |> 
  select(longitude, latitude,total=bio_mg_m3, sum=m3_poc) |> 
  plot.map2D(dim=4,  ylab = "meso", xlab = "epi",pal= "BlueYl")

p3<- bogrov.dt|>  
  select(longitude, latitude,ratio_epi_meso)|> 
  drop_na() |> 
  plot.map() +
  scale_color_gradientn(colours = my.colors,
                        trans="sqrt",
                        breaks=trans_breaks('sqrt', function(x) x^2),
                        labels=trans_format('sqrt', function(x) round(x^2,1)),
                        guide = guide_colourbar(title.position = "left",
                      barwidth=0.5,barheight=10,ticks=TRUE,
                          nbin = 10))+
  theme(legend.position = "right",
            legend.key.size= unit(0.2, "cm"),
            legend.spacing = unit(0, "cm"),
            legend.title = element_text(face="bold",angle = 90),
        legend.title.align = 0.5)+
  labs(color="Epi:Meso Biomas Ratio")
  
bogorov <- p1 /p3 / p2 + plot_layout(heights=c(1,1,1.1))
bogorov
```
```{r}
# estimate a total epipelagic zooplankton
bogrov.dt |>  
  summarize(total_epi=sum(bogrov_gC_m2, na.rm=TRUE)*3091.075*10^6/10^15)
psych::describe(bogrov.dt$ratio_epi_meso,quant=c(.25,.75) )
```




```{r Fig6, fig.height=10, fig.width=16, message=FALSE, warning=FALSE}
### combine Stromberg & Bogrov maps
(patch_stromberg | bogorov) + 
  plot_layout(heights = 1) +  
  plot_annotation(tag_levels =  c('A', '1')) & 
  theme(plot.tag = element_text("Times New Roman",face = "bold", size = 12,hjust = -3, vjust = 0))

ggsave("img/Fig.6_biomas-plots-StrombergBogrov_200-1000.png", width=16, height=10, units="in", dpi=300)
```


```{r}
ratios=obrien.dt |> select(ratio_epi_meso) |> drop_na() |> pull()
quantile(ratios, probs = seq(0, 1, 1/20))
```









